<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev SPA</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        #app { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h3 { margin-top: 30px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        button { padding: 10px 15px; background-color: #e51d3b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        button.secondary { background-color: #555; margin-left: 10px; }
        button:hover:not(:disabled) { background-color: #c41831; }
        button.secondary:hover:not(:disabled) { background-color: #444; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        input { padding: 10px; margin-bottom: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .error { color: red; margin-bottom: 15px; }
        .success { color: green; margin-bottom: 15px; }
        .order-list { margin-top: 20px; list-style: none; padding: 0; }
        .order-item { background: #f9f9f9; padding: 10px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 4px; }
        .order-item strong { display: block; margin-bottom: 5px; color: #555; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div id="app">
    <div class="nav-bar">
        <h1>Dev SPA</h1>
        <button v-if="auth.isAuthenticated" @click="logout">Cerrar Sesión</button>
    </div>

    <div v-if="!auth.isAuthenticated">
        <login-form v-if="currentView === 'login'" @login-success="fetchOrders" @go-register="currentView = 'register'"></login-form>
        <register-form v-else @go-login="currentView = 'login'"></register-form>
    </div>

    <orders-list v-else></orders-list>
</div>

<script>
    const { createApp, reactive, ref, computed, onMounted } = Vue;

    const API_URL = 'http://localhost:8000/api';

    const api = axios.create({
        baseURL: API_URL,
        headers: { 'Accept': 'application/json' }
    });

    const auth = reactive({
        token: localStorage.getItem('auth_token') || null,
        isAuthenticated: computed(() => !!auth.token),
        user: JSON.parse(localStorage.getItem('auth_user') || 'null'),
    });

    api.interceptors.request.use(config => {
        if (auth.token) {
            config.headers.Authorization = `Bearer ${auth.token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    const LoginForm = {
        template: `
          <h2>Iniciar Sesión</h2>
          <div v-if="error" class="error">{{ error }}</div>
          <form @submit.prevent="login">
            <input type="email" v-model="email" placeholder="Correo Electrónico" required>
            <input type="password" v-model="password" placeholder="Contraseña" required>
            <button type="submit" :disabled="loading">
              {{ loading ? 'Ingresando...' : 'Ingresar' }}
            </button>
            <button type="button" class="secondary" @click="$emit('go-register')" :disabled="loading">
              Registrarse
            </button>
          </form>
        `,
        setup(props, { emit }) {
            const email = ref('');
            const password = ref('');
            const loading = ref(false);
            const error = ref(null);

            const login = async () => {
                loading.value = true;
                error.value = null;

                try {
                    const response = await api.post('/auth/login', {
                        email: email.value,
                        password: password.value,
                    });

                    const token = response.data.data.access_token;
                    const userId = response.data.data.user_id;

                    auth.token = token;
                    localStorage.setItem('auth_token', token);

                    auth.user = { id: userId, email: email.value };
                    localStorage.setItem('auth_user', JSON.stringify(auth.user));

                    emit('login-success');

                } catch (err) {
                    const msg = err.response?.data?.message || 'Credenciales incorrectas o error de red.';
                    error.value = msg;
                    console.error('Login Error:', err);
                } finally {
                    loading.value = false;
                }
            };

            return { email, password, loading, error, login };
        }
    };

    const RegisterForm = {
        template: `
            <h2>Registro de Nuevo Usuario</h2>
            <div v-if="error" class="error">{{ error }}</div>
            <div v-if="success" class="success">{{ success }}</div>
            <form @submit.prevent="registerUser">
                <input type="text" v-model="name" placeholder="Nombre completo" required>
                <input type="email" v-model="email" placeholder="Correo Electrónico" required>
                <input type="password" v-model="password" placeholder="Contraseña (min. 6 caracteres)" required>
                <input type="text" v-model="phone_number" placeholder="Teléfono" required>

                <button type="submit" :disabled="loading">
                    {{ loading ? 'Registrando...' : 'Confirmar Registro' }}
                </button>
                <button type="button" class="secondary" @click="$emit('go-login')" :disabled="loading">
                    Volver al Login
                </button>
            </form>
        `,
        setup(props, { emit }) {
            const name = ref('');
            const email = ref('');
            const password = ref('');
            const phone_number = ref('');
            const loading = ref(false);
            const error = ref(null);
            const success = ref(null);

            const registerUser = async () => {
                loading.value = true;
                error.value = null;
                success.value = null;

                try {
                    const response = await api.post('/user/store', {
                        name: name.value,
                        email: email.value,
                        password: password.value,
                        phone_number: phone_number.value,
                    });

                    success.value = `¡Registro exitoso! Ya puedes iniciar sesión con ${email.value}.`;
                    name.value = '';
                    email.value = '';
                    password.value = '';
                    phone_number.value = '';

                } catch (err) {
                    const validationError = err.response?.data?.errors ?
                        Object.values(err.response.data.errors).flat().join('; ') :
                        err.response?.data?.message || 'Error en el servidor al registrar.';

                    error.value = validationError;
                    console.error('Register Error:', err);
                } finally {
                    loading.value = false;
                }
            };

            return { name, email, password, phone_number, loading, error, success, registerUser };
        }
    };


    const CreateOrderForm = {
        props: ['onOrderCreated'],
        template: `
          <h3>Crear Nueva Orden</h3>
          <div v-if="error" class="error">{{ error }}</div>
          <div v-if="success" class="success">{{ success }}</div>
          <form @submit.prevent="createOrder">
            <div class="form-group">
              <label>Nombre Cliente:</label>
              <input type="text" v-model="customer_first_name" required>
            </div>
            <div class="form-group">
              <label>Email Cliente:</label>
              <input type="email" v-model="customer_email" required>
            </div>

            <p>Ítem Fijo (Mouse Gamer, Cantidad: 1, Precio: 45.00)</p>

            <button type="submit" :disabled="loading">
              {{ loading ? 'Creando...' : 'Crear Orden' }}
            </button>
          </form>
        `,
        setup(props) {
            const customer_first_name = ref('Juan');
            const customer_email = ref('juan.perez@test.com');
            const loading = ref(false);
            const error = ref(null);
            const success = ref(null);

            const createOrder = async () => {
                loading.value = true;
                error.value = null;
                success.value = null;

                const payload = {
                    customer_first_name: customer_first_name.value,
                    customer_last_name: 'Perez',
                    customer_email: customer_email.value,
                    payment_method: 'credit_card',
                    items: [
                        {
                            product_name: 'Mouse Gamer',
                            quantity: 1,
                            unit_price: 45.00
                        }
                    ]
                };

                try {
                    const response = await api.post('/list/orders', payload);
                    success.value = `Orden #${response.data.data.id} creada exitosamente! Total: $${response.data.data.total_amount}`;

                    props.onOrderCreated();

                } catch (err) {
                    const validationError = err.response?.data?.errors ?
                        Object.values(err.response.data.errors).flat().join('; ') :
                        err.response?.data?.message || 'Error al crear la orden (¿Token válido?)';

                    error.value = validationError;
                    console.error('Create Order Error:', err);
                } finally {
                    loading.value = false;
                }
            };

            return { customer_first_name, customer_email, loading, error, success, createOrder };
        }
    };

    const OrdersList = {
        components: { CreateOrderForm },
        template: `
            <h2>Tus Órdenes (Usuario ID: {{ auth.user.id }})</h2>

            <create-order-form :onOrderCreated="fetchOrders"></create-order-form>

            <h3>Listado de Órdenes</h3>
            <div v-if="loading">Cargando órdenes...</div>
            <div v-else-if="error" class="error">Error al cargar las órdenes: {{ error }}</div>
            <div v-else-if="orders.length === 0">No tienes órdenes registradas.</div>
            <ul v-else class="order-list">
                <li v-for="order in orders" :key="order.id" class="order-item">
                    <strong>ID Orden: {{ order.id }}</strong>
                    <p>Cliente: {{ order.customer_first_name }} {{ order.customer_last_name }}</p>
                    <p>Total: $ {{ order.total_amount }} (Estado: {{ order.status }})</p>
                    <small>({{ order.items.length }} ítems)</small>
                </li>
            </ul>
        `,
        setup() {
            const orders = ref([]);
            const loading = ref(true);
            const error = ref(null);
            const localAuth = auth;

            const fetchOrders = async () => {
                loading.value = true;
                error.value = null;
                try {
                    const response = await api.get('/list/orders');
                    orders.value = response.data.data;
                } catch (err) {
                    error.value = err.response?.data?.message || 'Acceso denegado o error del servidor.';

                    if (err.response && (err.response.status === 401 || err.response.status === 403)) {
                        app.config.globalProperties.logout();
                    }
                } finally {
                    loading.value = false;
                }
            };

            onMounted(fetchOrders);

            return { orders, loading, error, fetchOrders, auth: localAuth };
        }
    };

    const app = createApp({
        setup() {
            const currentView = ref('login');

            const logout = async () => {
                try {
                    await api.post('/list/auth/logout');
                } catch (e) {
                    console.warn("Logout falló en el servidor, pero limpiando sesión local.");
                } finally {
                    auth.token = null;
                    auth.user = null;
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('auth_user');
                    currentView.value = 'login';
                }
            };

            app.config.globalProperties.logout = logout;

            return { auth, logout, currentView };
        }
    });

    app.component('login-form', LoginForm);
    app.component('register-form', RegisterForm);
    app.component('orders-list', OrdersList);
    app.component('create-order-form', CreateOrderForm);
    app.mount('#app');
</script>

</body>
</html>